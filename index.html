<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenClaw Quota Dashboard</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #121a2b;
      --line: #25324a;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --btn: #2563eb;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 24px;
    }
    .wrap { max-width: 1080px; margin: 0 auto; }
    h1 { margin: 0 0 8px; font-size: 28px; }
    .muted { color: var(--muted); }
    .top { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button {
      background: var(--btn);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
    }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .grid {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
    }
    .card h3 { margin: 0 0 8px; text-transform: capitalize; }
    .row { margin: 6px 0; }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--err); }
    code {
      background: #1f2937;
      padding: 2px 6px;
      border-radius: 6px;
      color: #d1d5db;
    }
    details {
      margin-top: 16px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
    }
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      margin: 8px 0 0;
      color: #cbd5e1;
    }
    .error-box {
      margin-top: 12px;
      background: rgba(239,68,68,.1);
      border: 1px solid rgba(239,68,68,.4);
      border-radius: 10px;
      padding: 10px 12px;
      color: #fecaca;
      display: none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>OpenClaw Quota Dashboard</h1>
    <p class="muted">Data source: <code>quota-status.json</code> | <span id="ts">loading...</span></p>

    <div class="top">
      <button id="refresh">Refresh</button>
      <span id="summary" class="muted"></span>
    </div>

    <div id="error" class="error-box"></div>
    <div id="system" class="grid"></div>
    <h3 style="margin-top:18px">Roadmap Priority</h3>
    <div id="roadmap" class="grid"></div>
    <h3 style="margin-top:18px">Providers</h3>
    <div id="cards" class="grid"></div>
    <h3 style="margin-top:18px">Automation Jobs</h3>
    <div id="jobs" class="grid"></div>

    <details>
      <summary>Raw JSON</summary>
      <pre id="raw">(loading)</pre>
    </details>
  </div>

  <script>
    function badgeClass(status) {
      if (status === "ok") return "ok";
      if (status === "configured" || status === "configured_but_not_ok") return "warn";
      return "err";
    }

    function fmt(v) {
      return v === null || v === undefined || v === "" ? "-" : String(v);
    }

    function statusText(p) {
      return `<span class="${badgeClass(p.status)}">${fmt(p.status)}</span>`;
    }

    function renderCards(providers) {
      const cardsEl = document.getElementById("cards");
      const entries = Object.entries(providers || {});
      if (entries.length === 0) {
        cardsEl.innerHTML = `<div class="card"><div class="row">No provider data found.</div></div>`;
        return;
      }

      cardsEl.innerHTML = entries.map(([name, p]) => `
        <div class="card">
          <h3>${name}</h3>
          <div class="row">Status: <b>${statusText(p)}</b></div>
          <div class="row">HTTP: ${fmt(p.http)}</div>
          <div class="row">Message: ${fmt(p.message)}</div>
          <div class="row">Remaining: ${fmt(p.remaining)}</div>
          <div class="row">Daily USD: ${fmt(p.usage_daily_usd)}</div>
          <div class="row">Weekly USD: ${fmt(p.usage_weekly_usd)}</div>
          <div class="row">Monthly USD: ${fmt(p.usage_monthly_usd)}</div>
          <div class="row">Key Source: ${fmt(p.key_source)}</div>
          <div class="row">Configured In OpenClaw: ${fmt(p.configured_in_openclaw_env)}</div>
          <div class="row">Monitor Mode: ${fmt(p.monitor_mode)}</div>
        </div>
      `).join("");
    }

    function renderSystem(system) {
      const el = document.getElementById("system");
      if (!system) {
        el.innerHTML = "";
        return;
      }
      const cls = system.gateway_port_listening ? "ok" : "err";
      el.innerHTML = `
        <div class="card">
          <h3>System</h3>
          <div class="row">OpenClaw: <b>${fmt(system.openclaw_version)}</b></div>
          <div class="row">Gateway Port 18789: <b class="${cls}">${system.gateway_port_listening ? "listening" : "down"}</b></div>
          <div class="row">Memory Index: <b>${fmt(system.memory_index_last_status)}</b></div>
          <div class="row">Memory Provider: <b>${fmt(system.memory_search_provider)}</b></div>
          <div class="row">Memory Model: <b>${fmt(system.memory_search_model)}</b></div>
          <div class="row">Memory Base URL: <b>${fmt(system.memory_search_base_url)}</b></div>
        </div>
      `;
    }

    function renderJobs(jobs) {
      const el = document.getElementById("jobs");
      const entries = Object.entries(jobs || {});
      if (entries.length === 0) {
        el.innerHTML = `<div class="card"><div class="row">No jobs found.</div></div>`;
        return;
      }
      el.innerHTML = entries.map(([name, j]) => {
        const st = fmt(j.state);
        const cls = st.includes("running") || st.includes("waiting") || st.includes("not running") ? "ok" : "warn";
        return `
          <div class="card">
            <h3>${name}</h3>
            <div class="row">Installed: <b>${fmt(j.installed)}</b></div>
            <div class="row">State: <b class="${cls}">${st}</b></div>
            <div class="row">Last Exit Code: ${fmt(j.last_exit_code)}</div>
          </div>
        `;
      }).join("");
    }

    function renderSummary(providers) {
      const list = Object.values(providers || {});
      const ok = list.filter(p => p.status === "ok").length;
      const warn = list.filter(p => p.status === "configured" || p.status === "configured_but_not_ok").length;
      const err = list.filter(p => !(p.status === "ok" || p.status === "configured" || p.status === "configured_but_not_ok")).length;
      document.getElementById("summary").textContent = `OK ${ok} · WARN ${warn} · ERR ${err}`;
    }

    function renderRoadmap(items) {
      const el = document.getElementById("roadmap");
      const arr = Array.isArray(items) ? items : [];
      if (arr.length === 0) {
        el.innerHTML = `<div class="card"><div class="row">No roadmap items.</div></div>`;
        return;
      }
      el.innerHTML = arr.map((r) => {
        const pr = String(r.priority || "-");
        const st = String(r.status || "-");
        const cls = st === "active" || st === "in_progress" ? "ok" : "warn";
        return `
          <div class="card">
            <h3>${pr}</h3>
            <div class="row">${r.item || "-"}</div>
            <div class="row">Status: <b class="${cls}">${st}</b></div>
          </div>
        `;
      }).join("");
    }

    async function load() {
      const btn = document.getElementById("refresh");
      const errEl = document.getElementById("error");
      errEl.style.display = "none";
      btn.disabled = true;

      try {
        const res = await fetch(`quota-status.json?ts=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        document.getElementById("ts").textContent = `Updated: ${fmt(data.timestamp_utc)}`;
        document.getElementById("raw").textContent = JSON.stringify(data, null, 2);

        renderSystem(data.system || {});
        renderRoadmap(data.roadmap || []);
        renderCards(data.providers || {});
        renderJobs(data.jobs || {});
        renderSummary(data.providers || {});
      } catch (e) {
        errEl.style.display = "block";
        errEl.textContent = `Load failed: ${e.message}`;
        document.getElementById("ts").textContent = "Update failed";
        document.getElementById("summary").textContent = "";
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById("refresh").addEventListener("click", load);
    load();
  </script>
</body>
</html>
